{% comment %}
  VersaCommerce Accessories Carousel - Horizontally scrollable row with pagination
{% endcomment %}

{% liquid
  assign title = section.settings.title | default: 'Complete Your Look'
  assign subtitle = section.settings.subtitle | default: 'Accessories'
  assign collection = section.settings.collection
  assign products_limit = section.settings.products_limit | default: 6
  
  if collection == blank
    assign collection = collections.accessories
    if collection == blank
      assign collection = collections.all
    endif
  endif
%}

{% if collection.products.size > 0 %}
  {% comment %} Build products array with aggressive size limits {% endcomment %}
  {% assign safe_products_limit = products_limit | default: 4 %}
  {% if safe_products_limit > 4 %}{% assign safe_products_limit = 4 %}{% endif %}

  {% capture products_json %}[{% for product in collection.products limit: safe_products_limit %}{% liquid
    # Aggressively truncate data to prevent JSON size issues
    assign product_title = product.title | default: 'Product' | strip | truncate: 30, ''
    assign product_price = product.price | default: 0
    assign product_url = product.url | default: '#'

    # Handle image safely with smaller dimensions
    assign image_url = ''
    if product.featured_image
      assign image_url = product.featured_image | image_url: width: 250, height: 250
    else
      assign image_url = 'product-placeholder.svg' | asset_url
    endif

    # Get first available variant for Quick Add functionality
    assign first_variant = product.variants.first
    assign variant_id = ''
    assign variant_available = false
    if first_variant
      assign variant_id = first_variant.id
      assign variant_available = first_variant.available
    endif
  %}{
    "id": {{ product.id | default: 0 | json }},
    "title": {{ product_title | json }},
    "price": {{ product_price | money | json }},
    "imageUrl": {{ image_url | json }},
    "productUrl": {{ product_url | json }},
    "variantId": {{ variant_id | json }},
    "available": {{ variant_available | json }}
  }{% unless forloop.last %},{% endunless %}{% endfor %}]{% endcapture %}

  {% capture carousel_props %}
  {
    "title": {{ title | json }},
    "subtitle": {{ subtitle | json }},
    "products": {{ products_json | strip }}
  }
  {% endcapture %}

  {% render 'react-component', component: 'AccessoriesCarousel', props: carousel_props %}
{% endif %}

{% schema %}
{
  "name": "Accessories Carousel",
  "tag": "section",
  "class": "accessories-carousel-section",
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Section Title",
      "default": "Complete Your Look"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Section Subtitle",
      "default": "Accessories"
    },
    {
      "type": "header",
      "content": "Products"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection",
      "info": "Leave empty to use 'accessories' collection or all products"
    },
    {
      "type": "range",
      "id": "products_limit",
      "label": "Number of products to show",
      "min": 3,
      "max": 12,
      "step": 1,
      "default": 6
    }
  ],
  "presets": [
    {
      "name": "Accessories Carousel",
      "settings": {
        "title": "Complete Your Look",
        "subtitle": "Accessories",
        "products_limit": 6
      }
    }
  ]
}
{% endschema %}
