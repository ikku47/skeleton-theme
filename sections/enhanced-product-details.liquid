{% comment %}
  Enhanced Product Details - Complete product information with variants, actions, and trust badges
{% endcomment %}

{% liquid
  assign product = product
  if product == blank
    assign product = collections.all.products.first
  endif
%}

{% if product %}
  {% comment %} Build variants JSON with null checks {% endcomment %}
  {% capture variants_json %}[{% if product.variants.size > 0 %}{% for variant in product.variants %}{% liquid
    assign variant_title = variant.title | default: 'Default' | strip | truncate: 50
    assign variant_price = variant.price | default: 0
    assign variant_compare_price = variant.compare_at_price | default: 0
    assign variant_available = variant.available | default: false

    # Build options object safely
    assign variant_options = ''
    for option in product.options
      assign option_value = variant.options[forloop.index0] | default: '' | strip
      assign option_name = option | strip
      if forloop.first
        assign variant_options = variant_options | append: '"' | append: option_name | append: '": "' | append: option_value | append: '"'
      else
        assign variant_options = variant_options | append: ', "' | append: option_name | append: '": "' | append: option_value | append: '"'
      endif
    endfor
  %}{
    "id": {{ variant.id | default: 0 | json }},
    "title": {{ variant_title | json }},
    "price": {{ variant_price | money | json }},{% if variant_compare_price > variant_price and variant_compare_price > 0 %}
    "compareAtPrice": {{ variant_compare_price | money | json }},{% endif %}
    "available": {{ variant_available | json }},
    "options": { {{ variant_options }} }
  }{% unless forloop.last %},{% endunless %}{% endfor %}{% endif %}]{% endcapture %}

  {% comment %} Build options JSON with null checks {% endcomment %}
  {% capture options_json %}[{% if product.options.size > 0 %}{% for option in product.options %}{% liquid
    assign option_name = option | default: 'Option' | strip | truncate: 30
    assign option_values = product.variants | map: 'options' | map: forloop.index0 | uniq | compact
  %}{
    "name": {{ option_name | json }},
    "values": [{% if option_values.size > 0 %}{% for value in option_values %}{% assign clean_value = value | default: '' | strip %}{% if clean_value != blank %}{{ clean_value | json }}{% unless forloop.last %},{% endunless %}{% endif %}{% endfor %}{% endif %}]
  }{% unless forloop.last %},{% endunless %}{% endfor %}{% endif %}]{% endcapture %}

  {% comment %} Build product JSON with safer handling and null checks {% endcomment %}
  {% liquid
    # Safely handle product data with fallbacks
    assign product_title = product.title | default: 'Untitled Product' | strip | truncate: 100
    assign product_description = product.description | default: '' | strip_html | strip | truncate: 300
    assign product_vendor = product.vendor | default: '' | strip | truncate: 50
    assign product_price = product.price | default: 0
    assign product_compare_price = product.compare_at_price | default: 0

    # Handle reviews safely
    assign rating_value = product.metafields.reviews.rating.value | default: 0
    assign review_count = product.metafields.reviews.rating_count.value | default: 0

    # Check if we have valid variants and options JSON
    assign safe_variants_json = variants_json | strip | default: '[]'
    assign safe_options_json = options_json | strip | default: '[]'

    # Ensure we have valid JSON arrays
    if safe_variants_json == blank or safe_variants_json == ''
      assign safe_variants_json = '[]'
    endif
    if safe_options_json == blank or safe_options_json == ''
      assign safe_options_json = '[]'
    endif
  %}

  {% capture product_json %}{
    "id": {{ product.id | default: 0 | json }},
    "title": {{ product_title | json }},{% if product_vendor != blank %}
    "vendor": {{ product_vendor | json }},{% endif %}
    "price": {{ product_price | money | json }},{% if product_compare_price > product_price and product_compare_price > 0 %}
    "compareAtPrice": {{ product_compare_price | money | json }},{% endif %}
    "description": {{ product_description | json }},
    "variants": {{ safe_variants_json }},
    "options": {{ safe_options_json }}{% if rating_value > 0 %},
    "rating": {{ rating_value | json }}{% endif %}{% if review_count > 0 %},
    "reviewCount": {{ review_count | json }}{% endif %}{% if product.tags.size > 0 %},
    "tags": [{% for tag in product.tags %}{{ tag | strip | json }}{% unless forloop.last %},{% endunless %}{% endfor %}]{% else %},
    "tags": []{% endif %}
  }{% endcapture %}

  {% capture details_props %}
  {
    "product": {{ product_json | strip }},
    "showTrustBadges": {{ section.settings.show_trust_badges | json }},
    "trustBadges": [
      {
        "text": {{ section.settings.trust_badge_1_text | default: "Free shipping on orders over $50" | json }},
        "show": {{ section.settings.show_trust_badge_1 | json }}
      },
      {
        "text": {{ section.settings.trust_badge_2_text | default: "30-day return policy" | json }},
        "show": {{ section.settings.show_trust_badge_2 | json }}
      },
      {
        "text": {{ section.settings.trust_badge_3_text | default: "Secure payment guaranteed" | json }},
        "show": {{ section.settings.show_trust_badge_3 | json }}
      },
      {
        "text": {{ section.settings.trust_badge_4_text | default: "24/7 customer support" | json }},
        "show": {{ section.settings.show_trust_badge_4 | json }}
      }
    ]
  }
  {% endcapture %}

  {% render 'react-component', component: 'EnhancedProductDetails', props: details_props %}
{% endif %}

{% schema %}
{
  "name": "Enhanced Product Details",
  "tag": "section",
  "class": "enhanced-product-details-section",
  "settings": [
    {
      "type": "header",
      "content": "Product Information"
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "label": "Show product vendor",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_rating",
      "label": "Show product rating",
      "default": true,
      "info": "Requires review app integration"
    },
    {
      "type": "header",
      "content": "Trust Badges"
    },
    {
      "type": "checkbox",
      "id": "show_trust_badges",
      "label": "Show trust badges",
      "default": true,
      "info": "Display trust badges below product actions"
    },
    {
      "type": "checkbox",
      "id": "show_trust_badge_1",
      "label": "Show shipping badge",
      "default": true
    },
    {
      "type": "text",
      "id": "trust_badge_1_text",
      "label": "Shipping badge text",
      "default": "Free shipping on orders over $50"
    },
    {
      "type": "checkbox",
      "id": "show_trust_badge_2",
      "label": "Show return policy badge",
      "default": true
    },
    {
      "type": "text",
      "id": "trust_badge_2_text",
      "label": "Return policy badge text",
      "default": "30-day return policy"
    },
    {
      "type": "checkbox",
      "id": "show_trust_badge_3",
      "label": "Show security badge",
      "default": true
    },
    {
      "type": "text",
      "id": "trust_badge_3_text",
      "label": "Security badge text",
      "default": "Secure payment guaranteed"
    },
    {
      "type": "checkbox",
      "id": "show_trust_badge_4",
      "label": "Show support badge",
      "default": true
    },
    {
      "type": "text",
      "id": "trust_badge_4_text",
      "label": "Support badge text",
      "default": "24/7 customer support"
    },
    {
      "type": "header",
      "content": "Actions"
    },
    {
      "type": "checkbox",
      "id": "show_wishlist",
      "label": "Show wishlist button",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_share",
      "label": "Show share button",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_buy_now",
      "label": "Show buy now button",
      "default": false,
      "info": "Requires Shopify Payments or compatible payment gateway"
    }
  ],
  "presets": [
    {
      "name": "Enhanced Product Details"
    }
  ]
}
{% endschema %}
