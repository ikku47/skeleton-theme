{% comment %}
  Enhanced Search Page Section with filtering and view options
{% endcomment %}

<section class="bg-white min-h-screen">
  <div class="container">


{% liquid
  assign results_per_page = section.settings.results_per_page | default: 20
%}
{% paginate search.results by results_per_page %}
  {% comment %} Build search results array for VersaSearchPage {% endcomment %}
  {% capture search_results_json %}
  [
    {% if search.performed %}
      {% for result in search.results %}
        {% liquid
          assign result_type = result.object_type | default: 'page'

          if result_type == 'product'
            assign result_title = result.title | default: 'Untitled Product'
            assign result_url = result.url | default: '#'
            assign result_image = result.featured_image
            assign result_price = result.price | money | default: ''
            assign result_excerpt = result.description | strip_html | truncate: 150 | default: ''
            assign result_published = ''

            # Get the first available variant - search results use selected_or_first_available_variant
            assign first_variant = result.selected_or_first_available_variant
            assign variant_id = first_variant.id | default: result.variants.first.id | default: result.id
            assign variant_available = first_variant.available | default: result.available | default: true

            if result_image
              assign image_url = result_image | image_url: width: 400, height: 500
            else
              assign image_url = 'product-placeholder.svg' | asset_url
            endif
          elsif result_type == 'article'
            assign result_title = result.title | default: 'Untitled Article'
            assign result_url = result.url | default: '#'
            assign result_image = result.image
            assign result_price = ''
            assign result_excerpt = result.summary | strip_html | truncate: 150 | default: ''
            assign result_published = result.published_at | date: '%Y-%m-%d'

            if result_image
              assign image_url = result_image | image_url: width: 300, height: 200
            else
              assign image_url = ''
            endif
          else
            assign result_title = result.title | default: 'Untitled Page'
            assign result_url = result.url | default: '#'
            assign result_image = ''
            assign result_price = ''
            assign result_excerpt = result.content | strip_html | truncate: 150 | default: ''
            assign result_published = ''
            assign image_url = ''
          endif
        %}
        {
          "id": {{ result.id | default: forloop.index | json }},
          "title": {{ result_title | json }},
          "url": {{ result_url | json }},
          "type": {{ result_type | json }}{% if image_url != blank %},
          "image": {{ image_url | json }}{% endif %}{% if result_price != blank %},
          "price": {{ result_price | json }}{% endif %}{% if result_excerpt != blank %},
          "excerpt": {{ result_excerpt | json }}{% endif %}{% if result_published != blank %},
          "published_at": {{ result_published | json }}{% endif %}{% if result_type == 'product' %},
          "variantId": {{ variant_id | json }},
          "available": {{ variant_available | json }},
          "tags": {{ result.tags | json }},
          "vendor": {{ result.vendor | json }},
          "productType": {{ result.type | json }}{% endif %}
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    {% endif %}
  ]
  {% endcapture %}

  {% capture search_page_props %}
  {
    "results": {{ search_results_json | strip }},
    "query": {{ search.terms | default: '' | json }},
    "totalResults": {{ search.results_count | default: 0 }},
    "searchFormProps": {
      "initialQuery": {{ search.terms | default: '' | json }},
      "placeholder": {{ section.settings.search_placeholder | default: 'Search products, articles, and pages...' | json }}
    }
  }
  {% endcapture %}

  {% render 'react-component', component: 'VersaSearchPage', props: search_page_props %}
{% endpaginate %}
 </div>
</section>

{% schema %}
{
  "name": "Enhanced Search",
  "tag": "section",
  "class": "search-page",
  "settings": [
    {
      "type": "header",
      "content": "Search Settings"
    },
    {
      "type": "range",
      "id": "results_per_page",
      "label": "Results per page",
      "min": 10,
      "max": 50,
      "step": 5,
      "default": 20,
      "info": "Number of search results to show per page"
    },
    {
      "type": "text",
      "id": "search_placeholder",
      "label": "Search placeholder text",
      "default": "Search products, articles, and pages...",
      "info": "Placeholder text shown in the search input"
    },
    {
      "type": "checkbox",
      "id": "show_product_filters",
      "label": "Show product filters",
      "default": true,
      "info": "Display filter sidebar for product search results"
    },
    {
      "type": "checkbox",
      "id": "show_view_toggle",
      "label": "Show grid/list view toggle",
      "default": true,
      "info": "Allow customers to switch between grid and list views for products"
    },
    {
      "type": "select",
      "id": "default_view",
      "label": "Default view mode",
      "options": [
        { "value": "grid", "label": "Grid View" },
        { "value": "list", "label": "List View" }
      ],
      "default": "grid"
    },
    {
      "type": "range",
      "id": "default_grid_columns",
      "label": "Default grid columns",
      "min": 2,
      "max": 5,
      "step": 1,
      "default": 4,
      "info": "Number of columns in grid view for product results"
    }
  ],
  "presets": [
    {
      "name": "Enhanced Search"
    }
  ]
}
{% endschema %}
