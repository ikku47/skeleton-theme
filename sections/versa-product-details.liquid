{% comment %}
  VersaCommerce Product Details - Enhanced product information with variants
{% endcomment %}

{% liquid
  assign product = product
  if product == blank
    assign product = collections.all.products.first
  endif
%}

{% if product %}
  {% capture variants_json %}
  [
    {% for variant in product.variants %}
      {
        "id": {{ variant.id | json }},
        "title": {{ variant.title | json }},
        "price": {{ variant.price | money | json }},
        {% if variant.compare_at_price > variant.price %}
        "compareAtPrice": {{ variant.compare_at_price | money | json }},
        {% endif %}
        "available": {{ variant.available | json }},
        "options": {
          {% for option in product.options_with_values %}
            {% assign option_position = forloop.index0 %}
            "{{ option.name }}": {{ variant.options[option_position] | json }}{% unless forloop.last %},{% endunless %}
          {% endfor %}
        }
      }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ]
  {% endcapture %}

  {% capture options_json %}
  [
    {% for option in product.options_with_values %}
      {
        "name": {{ option.name | json }},
        "values": [
          {% for value in option.values %}
            {{ value | json }}{% unless forloop.last %},{% endunless %}
          {% endfor %}
        ]
      }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ]
  {% endcapture %}

  {% capture product_json %}
  {
    "id": {{ product.id | json }},
    "title": {{ product.title | json }},
    {% if product.vendor != blank %}"vendor": {{ product.vendor | json }},{% endif %}
    "price": {{ product.price | money | json }},
    {% if product.compare_at_price > product.price %}
    "compareAtPrice": {{ product.compare_at_price | money | json }},
    {% endif %}
    "description": {{ product.description | json }},
    "variants": {{ variants_json | strip }},
    "options": {{ options_json | strip }}
    {% if product.metafields.reviews.rating.value %}
    ,"rating": {{ product.metafields.reviews.rating.value | json }}
    {% endif %}
    {% if product.metafields.reviews.rating_count.value %}
    ,"reviewCount": {{ product.metafields.reviews.rating_count.value | json }}
    {% endif %}
    {% if product.tags.size > 0 %}
    ,"tags": [
      {% for tag in product.tags %}
        {{ tag | json }}{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ]
    {% endif %}
  }
  {% endcapture %}

  {% capture details_props %}
  {
    "product": {{ product_json | strip }}
  }
  {% endcapture %}

  {% render 'react-component', component: 'VersaProductDetails', props: details_props %}
{% endif %}

{% schema %}
{
  "name": "Versa Product Details",
  "tag": "section",
  "class": "versa-product-details-section",
  "settings": [],
  "presets": [
    {
      "name": "Versa Product Details"
    }
  ]
}
{% endschema %}
